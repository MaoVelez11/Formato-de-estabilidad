<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Formato Estudio de Estabilidad</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>

  <header>
    <img src="logo.png" alt="Logo de la Empresa" class="logo">
    <h1>Formato de Estudio de Estabilidad</h1>
  </header>

<main>
  <form id="formatoEstabilidad">
    <h2>I. Información del Producto</h2>
    <table>
      <tr><td class="label">Producto:</td><td><input type="text" id="producto" name="producto"></td></tr>
      <tr><td class="label">Descripción:</td><td><input type="text" id="descripcion" name="descripcion"></td></tr>
      <tr><td class="label">Registro Sanitario:</td><td><input type="text" id="registroSanitario" name="registroSanitario"></td></tr>
      <tr><td class="label">Lote:</td><td><input type="text" id="lote" name="lote"></td></tr>
      <tr><td class="label">Lote Interno:</td><td><input type="text" id="loteInterno" name="loteInterno"></td></tr>
      <tr><td class="label">Unidades:</td><td><input type="number" id="unidades" name="unidades"></td></tr>
      <tr><td class="label">Fecha Fabricación:</td><td><input type="date" id="fechaFabricacion" name="fechaFabricacion"></td></tr>
      <tr><td class="label">Fecha Inicio Estabilidad:</td><td><input type="date" id="fechaInicio" name="fechaInicio"></td></tr>
      <tr><td class="label">Pruebas a Realizar:</td><td><input type="text" id="pruebas" name="pruebas"></td></tr>
      <tr><td class="label">Observaciones:</td><td><textarea id="observaciones" name="observaciones"></textarea></td></tr>
    </table>

    <h2>II. Pruebas Fisicoquímicas</h2>
    <table>
        <thead>
            <tr>
                <th>Tiempo</th><th>Apariencia</th><th>Color</th><th>Olor</th><th>pH</th><th>Viscosidad</th><th>Densidad</th>
            </tr>
        </thead>
        <tbody>
            <script>
                const tiempos = [0, 1, 3, 6, 9, 12, 18, 24, 30, 36];
                for (const t of tiempos) {
                    document.write(`
                    <tr>
                        <td>T${t}</td>
                        <td><input type="text" name="fisicoquimico_t${t}_apariencia"></td>
                        <td><input type="text" name="fisicoquimico_t${t}_color"></td>
                        <td><input type="text" name="fisicoquimico_t${t}_olor"></td>
                        <td><input type="text" name="fisicoquimico_t${t}_ph"></td>
                        <td><input type="text" name="fisicoquimico_t${t}_viscosidad"></td>
                        <td><input type="text" name="fisicoquimico_t${t}_densidad"></td>
                    </tr>
                    `);
                }
            </script>
        </tbody>
    </table>

    <h2>III. Pruebas Microbiológicas</h2>
    <table>
        <thead>
            <tr>
                <th>Tiempo</th><th>Mesófilos Aerobios</th><th>Pseudomona</th><th>E. Coli</th><th>Staphylococcus</th>
            </tr>
        </thead>
        <tbody>
             <script>
                for (const t of tiempos) {
                    document.write(`
                    <tr>
                        <td>T${t}</td>
                        <td><input type="text" name="microbiologico_t${t}_mesofilos"></td>
                        <td><input type="text" name="microbiologico_t${t}_pseudomona"></td>
                        <td><input type="text" name="microbiologico_t${t}_ecoli"></td>
                        <td><input type="text" name="microbiologico_t${t}_staphylococcus"></td>
                    </tr>
                    `);
                }
            </script>
        </tbody>
    </table>
  </form>

  <div class="acciones-formulario">
    <button class="boton-guardar" onclick="guardarDatos()">💾 Guardar Cambios</button>
    <a href="seguimiento.html" class="boton-volver">↩️ Volver a Seguimiento</a>
  </div>
</main>

<script>
const DB_NAME = "EstabilidadDB";
const STORE_NAME = "productos";
let db;
let productoId;

function initDb() {
    return new Promise((resolve, reject) => {
        const request = indexedDB.open(DB_NAME, 1);
        request.onupgradeneeded = event => {
            const db = event.target.result;
            if (!db.objectStoreNames.contains(STORE_NAME)) {
                db.createObjectStore(STORE_NAME, { keyPath: "id", autoIncrement: true });
            }
        };
        request.onsuccess = event => {
            db = event.target.result;
            resolve(db);
        };
        request.onerror = event => reject(event.target.errorCode);
    });
}

async function cargarDatos() {
    await initDb();
    const params = new URLSearchParams(window.location.search);
    productoId = parseInt(params.get('id'), 10);

    if (!productoId) {
        alert("No se ha especificado un ID de producto.");
        window.location.href = 'seguimiento.html';
        return;
    }

    const transaction = db.transaction(STORE_NAME, "readonly");
    const objectStore = transaction.objectStore(STORE_NAME);
    const request = objectStore.get(productoId);

    request.onsuccess = event => {
        const producto = event.target.result;
        if (producto) {
            // Cargar datos de la sección I
            document.getElementById('producto').value = producto.producto || '';
            document.getElementById('descripcion').value = producto.descripcion || '';
            document.getElementById('registroSanitario').value = producto.registroSanitario || '';
            document.getElementById('lote').value = producto.lote || '';
            document.getElementById('loteInterno').value = producto.loteInterno || '';
            document.getElementById('unidades').value = producto.unidades || '';
            document.getElementById('fechaFabricacion').value = producto.fechaFabricacion || '';
            document.getElementById('fechaInicio').value = producto.fechaInicio || '';
            document.getElementById('pruebas').value = producto.pruebas || '';
            document.getElementById('observaciones').value = producto.observaciones || '';
            
            // Cargar datos de las tablas de Tiempos (II y III)
            if (producto.datosFormato) {
                const formElements = document.getElementById('formatoEstabilidad').elements;
                for (const element of formElements) {
                    if (element.name && producto.datosFormato[element.name]) {
                        element.value = producto.datosFormato[element.name];
                    }
                }
            }
        } else {
            alert("Producto no encontrado.");
        }
    };
}

async function guardarDatos() {
    if (!db || !productoId) {
        alert("Error: No se puede guardar. Recargue la página.");
        return;
    }

    const transaction = db.transaction(STORE_NAME, "readwrite");
    const objectStore = transaction.objectStore(STORE_NAME);
    const requestGet = objectStore.get(productoId);

    requestGet.onsuccess = event => {
        const producto = event.target.result;
        if (producto) {
            // Actualizar datos de la sección I
            producto.producto = document.getElementById('producto').value;
            producto.descripcion = document.getElementById('descripcion').value;
            producto.registroSanitario = document.getElementById('registroSanitario').value;
            producto.lote = document.getElementById('lote').value;
            producto.loteInterno = document.getElementById('loteInterno').value;
            producto.unidades = document.getElementById('unidades').value;
            producto.fechaFabricacion = document.getElementById('fechaFabricacion').value;
            producto.fechaInicio = document.getElementById('fechaInicio').value;
            producto.pruebas = document.getElementById('pruebas').value;
            producto.observaciones = document.getElementById('observaciones').value;

            // Guardar todos los campos de las tablas
            producto.datosFormato = {};
            const formElements = document.getElementById('formatoEstabilidad').elements;
            for (const element of formElements) {
                if (element.name && element.name.includes('_t')) { // Solo guardar campos de tiempo
                    producto.datosFormato[element.name] = element.value;
                }
            }

            const requestUpdate = objectStore.put(producto);
            requestUpdate.onsuccess = () => {
                alert("¡Datos guardados exitosamente!");
                window.location.href = 'seguimiento.html';
            };
            requestUpdate.onerror = () => alert("Error al guardar los datos.");
        }
    };
}

window.onload = cargarDatos;
</script>

</body>
</html>