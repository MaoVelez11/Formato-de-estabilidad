<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <title>Seguimiento de Productos en Estabilidad</title>
    <link rel="stylesheet" href="styles.css" />
    <style>
        /* Estilos base para una correcta visualizaci√≥n */
        th, td {
            border: 1px solid #ccc;
            padding: 4px;
            text-align: center;
            vertical-align: top;
        }
        textarea {
            width: 95%;
            min-height: 50px;
            resize: vertical;
            box-sizing: border-box;
        }
        th {
            background-color: #f0f0f0;
            color: #333;
        }
        .acelerada { background-color: #fdd; }
        .natural { background-color: #dfd; }
        .aprobacion { background-color: #ffecb3; }
        #tablaEstabilidad thead tr:nth-child(2) th { background-color: #fff; }
        .table-wrapper { overflow-x: auto; }

        /* ==== Reset & layout base ==== */
        * { box-sizing: border-box; }
        html, body { margin: 0; padding: 0; overflow-x: hidden; }
        body {
            font-family: Arial, sans-serif;
            background: #fdfdfd;
            color: #333;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* ==== MODIFICACIONES EN HEADER ==== */
        header {
            display: flex;
            align-items: center;
            justify-content: space-between; /* Alinea los elementos a los extremos */
            gap: 12px;
            margin-bottom: 20px;
            border-bottom: 3px solid #e6b8af;
            padding-bottom: 25px;
        }

        .header-title { /* Contenedor para logo y t√≠tulo */
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .header-actions { /* Contenedor para los nuevos botones */
            display: flex;
            gap: 10px;
        }
        
        /* Estilo espec√≠fico para los botones en la cabecera */
        .header-actions .btn {
            padding: 8px 16px; /* Hacemos los botones m√°s peque√±os */
            font-size: 14px;   /* Reducimos el texto */
            margin-top: 0;     /* Quitamos el margen superior */
        }

        header img { height: 60px; }
        header h1 {
            color: #6a4f6d;
            font-size: 24px;
            margin: 0;
        }
        
        /* ==== Estilos Generales (sin cambios) ==== */
        h2 {
            background: #e6b8af;
            padding: 10px;
            text-align: center;
            font-size: 18px;
            color: #fff;
            border-radius: 5px;
        }
        table {
            border-collapse: collapse;
            margin-bottom: 25px;
            width: 100%;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        input[type='text'], input[type='date'], input[type='number'], select, textarea {
            width: 100%;
            padding: 6px;
            box-sizing: border-box;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .btn {
            padding: 10px 20px;
            background: #f37f58;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            text-decoration: none;
            display: inline-flex; /* Para alinear √≠cono y texto */
            align-items: center;
            gap: 8px; /* Espacio entre √≠cono y texto */
            margin-top: 15px;
        }
        .btn:hover { background: #e06d4a; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-title">
                <img src="/logo.png" alt="Samara Cosmetics Logo" />
                <h1>M√≥dulo de Seguimiento de Estabilidad</h1>
            </div>

            <div class="header-actions">
                <a href="formato.html" class="btn">‚ûï Agregar producto</a>
                <button class="btn" style="background-color: #dc3545" onclick="eliminarFila()">üóëÔ∏è Eliminar Fila</button>
                <button class="btn" style="background-color: #65b45a" onclick="guardarDatosSeguimiento()">üíæ Guardar Datos</button>
            </div>
        </header>

        <h2>SEGUIMIENTO PRODUCTOS EN PRUEBAS DE ESTABILIDAD ACELERADA Y NATURAL</h2>

        <div class="table-wrapper">
            <table id="tablaEstabilidad">
                <thead>
                    <tr>
                        <th rowspan="2">‚úî</th>
                        <th rowspan="2">Consecutivo</th>
                        <th rowspan="2">Referencia</th>
                        <th rowspan="2">Producto</th>
                        <th rowspan="2">Registro Sanitario</th>
                        <th rowspan="2">Lote</th>
                        <th rowspan="2">Descripci√≥n</th>
                        <th rowspan="2">Pruebas</th>
                        <th rowspan="2">Observaciones</th>
                        <th rowspan="2">Total Unidades</th>
                        <th class="acelerada" colspan="6">Estabilidad Acelerada</th>
                        <th class="natural" colspan="12">Estabilidad Natural</th>
                        <th class="aprobacion" colspan="2">Aprobaci√≥n</th>
                        <th rowspan="2">Tiempo Exp. (meses)</th>
                        <th colspan="2">Estad√≠sticos</th>
                        <th rowspan="2">Comentarios</th>
                        <th rowspan="2">Acci√≥n</th>
                    </tr>
                    <tr>
                        <th>Cantidad</th><th>Ubicaci√≥n</th><th>T0</th><th>T1</th><th>T2</th><th>T3</th>
                        <th>Cantidad</th><th>Ubicaci√≥n</th><th>T3</th><th>T6</th><th>T9</th><th>T12</th>
                        <th>T18</th><th>T24</th><th>T27</th><th>T30</th><th>T33</th><th>T36</th>
                        <th>Sin Fecha Exp.</th><th>Con Fecha Exp.</th>
                        <th>S√≠</th><th>No</th>
                    </tr>
                </thead>
                <tbody>
                    </tbody>
            </table>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            cargarProductos();
        });

        function cargarProductos() {
            const productos = JSON.parse(localStorage.getItem('productosEstabilidad')) || [];
            const tbody = document.getElementById('tablaEstabilidad').getElementsByTagName('tbody')[0];
            
            tbody.innerHTML = ''; // Limpia la tabla antes de cargar

            if (productos.length === 0) {
                 const filaVacia = `<tr><td colspan="34" style="text-align:center; padding: 20px;">No hay productos en seguimiento. Agregue uno nuevo para comenzar.</td></tr>`;
                tbody.innerHTML = filaVacia;
                return;
            }

            productos.forEach((producto, index) => {
                const nuevaFila = tbody.insertRow();
                nuevaFila.innerHTML = `
                    <td><input type="checkbox" /></td>
                    <td class="consec">${index + 1}</td>
                    <td><input type="text" class="campo" value="${producto.referencia || ''}" /></td>
                    <td><textarea class="campo">${producto.producto || ''}</textarea></td>
                    <td><input type="text" class="campo" value="${producto.nso || ''}" /></td>
                    <td><input type="text" class="campo" value="${producto.lote || ''}" readonly style="background-color:#eee;" /></td>
                    <td><textarea class="campo">${producto.descripcion || ''}</textarea></td>
                    <td><textarea class="pruebas">${producto.pruebas || 'Apariencia, color, pH, Densidad, Viscosidad, Aplicaci√≥n, microbiolog√≠a'}</textarea></td>
                    <td><textarea>${producto.observaciones || ''}</textarea></td>
                    <td><input type="number" min="0" value="${producto.total_unidades || ''}" /></td>
                    
                    <td><input type="number" min="0" value="${producto.acelerada_cantidad || ''}" /></td>
                    <td><input type="text" value="${producto.acelerada_ubicacion || ''}" /></td>
                    <td><input type="date" value="${producto.acelerada_t0 || ''}" /></td>
                    <td><input type="date" value="${producto.acelerada_t1 || ''}" /></td>
                    <td><input type="date" value="${producto.acelerada_t2 || ''}" /></td>
                    <td><input type="date" value="${producto.acelerada_t3 || ''}" /></td>
                    
                    <td><input type="number" min="0" value="${producto.natural_cantidad || ''}" /></td>
                    <td><input type="text" value="${producto.natural_ubicacion || ''}" /></td>
                    <td><input type="date" value="${producto.natural_t3 || ''}" /></td>
                    <td><input type="date" value="${producto.natural_t6 || ''}" /></td>
                    <td><input type="date" value="${producto.natural_t9 || ''}" /></td>
                    <td><input type="date" value="${producto.natural_t12 || ''}" /></td>
                    <td><input type="date" value="${producto.natural_t18 || ''}" /></td>
                    <td><input type="date" value="${producto.natural_t24 || ''}" /></td>
                    <td><input type="date" value="${producto.natural_t27 || ''}" /></td>
                    <td><input type="date" value="${producto.natural_t30 || ''}" /></td>
                    <td><input type="date" value="${producto.natural_t33 || ''}" /></td>
                    <td><input type="date" value="${producto.natural_t36 || ''}" /></td>
                    
                    <td><input type="radio" name="aprob${index + 1}" value="Sin Fecha Exp." ${producto.aprobacion === 'Sin Fecha Exp.' ? 'checked' : ''} /></td>
                    <td><input type="radio" name="aprob${index + 1}" value="Con Fecha Exp." ${producto.aprobacion === 'Con Fecha Exp.' ? 'checked' : ''} /></td>
                    
                    <td><input type="number" min="0" value="${producto.tiempo_exp_meses || ''}" /></td>
                    
                    <td><input type="radio" name="estad${index + 1}" value="si" ${producto.estadisticos === 'si' ? 'checked' : ''} /></td>
                    <td><input type="radio" name="estad${index + 1}" value="no" ${producto.estadisticos === 'no' ? 'checked' : ''} /></td>
                    
                    <td><textarea>${producto.comentarios || ''}</textarea></td>
                    <td>
                        <button class="btn" style="padding: 6px 12px; font-size: 12px" onclick="editarProducto(this)">
                            Acceder / Editar
                        </button>
                    </td>
                `;
                asignarEventosFila(nuevaFila);
            });
        }

        function guardarDatosSeguimiento() {
            let productos = JSON.parse(localStorage.getItem('productosEstabilidad')) || [];
            const filas = document.querySelectorAll('#tablaEstabilidad tbody tr');

            filas.forEach((fila) => {
                // Si la fila es el mensaje de "tabla vac√≠a", la ignoramos
                if (fila.cells.length < 5) return;

                const lote = fila.cells[5].querySelector('input').value;
                const productoIndex = productos.findIndex(p => p.lote === lote);

                if (productoIndex > -1) {
                    // Actualizamos el objeto del producto con los datos de la fila
                    const datosFila = {
                        referencia: fila.cells[2].querySelector('input').value,
                        producto: fila.cells[3].querySelector('textarea').value,
                        nso: fila.cells[4].querySelector('input').value,
                        lote: lote, // El lote no se modifica
                        descripcion: fila.cells[6].querySelector('textarea').value,
                        pruebas: fila.cells[7].querySelector('textarea').value,
                        observaciones: fila.cells[8].querySelector('textarea').value,
                        total_unidades: fila.cells[9].querySelector('input').value,
                        acelerada_cantidad: fila.cells[10].querySelector('input').value,
                        acelerada_ubicacion: fila.cells[11].querySelector('input').value,
                        acelerada_t0: fila.cells[12].querySelector('input').value,
                        acelerada_t1: fila.cells[13].querySelector('input').value,
                        acelerada_t2: fila.cells[14].querySelector('input').value,
                        acelerada_t3: fila.cells[15].querySelector('input').value,
                        natural_cantidad: fila.cells[16].querySelector('input').value,
                        natural_ubicacion: fila.cells[17].querySelector('input').value,
                        natural_t3: fila.cells[18].querySelector('input').value,
                        natural_t6: fila.cells[19].querySelector('input').value,
                        natural_t9: fila.cells[20].querySelector('input').value,
                        natural_t12: fila.cells[21].querySelector('input').value,
                        natural_t18: fila.cells[22].querySelector('input').value,
                        natural_t24: fila.cells[23].querySelector('input').value,
                        natural_t27: fila.cells[24].querySelector('input').value,
                        natural_t30: fila.cells[25].querySelector('input').value,
                        natural_t33: fila.cells[26].querySelector('input').value,
                        natural_t36: fila.cells[27].querySelector('input').value,
                        aprobacion: fila.querySelector('input[name^="aprob"]:checked')?.value || '',
                        tiempo_exp_meses: fila.cells[30].querySelector('input').value,
                        estadisticos: fila.querySelector('input[name^="estad"]:checked')?.value || '',
                        comentarios: fila.cells[33].querySelector('textarea').value,
                    };

                    // Se combinan los datos originales con los nuevos
                    productos[productoIndex] = { ...productos[productoIndex], ...datosFila };
                }
            });

            // Guardar la lista actualizada en localStorage
            localStorage.setItem('productosEstabilidad', JSON.stringify(productos));
            
            // Aqu√≠ tambi√©n ir√≠a la l√≥gica para enviar a SQL Server
            /*
            fetch('/api/actualizarSeguimiento', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(productos)
            })
            .then(res => res.json())
            .then(response => {
                alert(response.message || 'Datos guardados en el servidor con √©xito');
            })
            .catch(error => console.error('Error al guardar en servidor:', error));
            */
            
            alert('Datos del seguimiento guardados correctamente.');
        }

        function autoResize(el) {
            el.style.height = 'auto';
            el.style.height = el.scrollHeight + 'px';
        }

        function actualizarConsecutivos() {
            document.querySelectorAll('#tablaEstabilidad tbody tr').forEach((fila, i) => {
                const consec_cell = fila.querySelector('.consec');
                if (consec_cell) consec_cell.innerText = i + 1;
            });
        }
        
        function eliminarFila() {
            const tbody = document.getElementById('tablaEstabilidad').getElementsByTagName('tbody')[0];
            const filasParaEliminar = Array.from(tbody.querySelectorAll("input[type='checkbox']:checked"));
            
            if (filasParaEliminar.length === 0) {
                alert('Por favor, seleccione al menos una fila para eliminar.');
                return;
            }

            if (confirm(`¬øEst√° seguro de que desea eliminar las ${filasParaEliminar.length} fila(s) seleccionada(s)?`)) {
                let productos = JSON.parse(localStorage.getItem('productosEstabilidad')) || [];
                
                filasParaEliminar.forEach((chk) => {
                    const fila = chk.closest('tr');
                    const lote = fila.cells[5].querySelector('input').value;
                    productos = productos.filter(p => p.lote !== lote);
                    fila.remove();
                });
                
                localStorage.setItem('productosEstabilidad', JSON.stringify(productos));
                actualizarConsecutivos();

                if (tbody.rows.length === 0) {
                    cargarProductos();
                }
            }
        }

        function asignarEventosFila(fila) {
            fila.querySelectorAll('textarea').forEach((area) => {
                autoResize(area);
                area.addEventListener('input', () => autoResize(area));
            });
        }

        function editarProducto(boton) {
            const fila = boton.closest('tr');
            const lote = fila.cells[5].querySelector('input').value;
            if (lote) {
                window.location.href = `formato.html?lote=${encodeURIComponent(lote)}`;
            } else {
                alert('No se encontr√≥ un n√∫mero de lote para este producto.');
            }
        }
    </script>
</body>
</html>